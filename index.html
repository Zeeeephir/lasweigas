<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LasWei'GAs Music DJ App</title>
    
    <!-- Importation de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Importation des polices personnalis√©es -->
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Ic√¥nes Lucide pour les √©l√©ments visuels (Version UMD pour un acc√®s global) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        /* Styles CSS pour l'ambiance Las Vegas */
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: #000;
            color: #fff;
        }
        .text-shadow-neon {
            text-shadow:
                0 0 7px rgba(255, 105, 180, 0.7), /* Pink */
                0 0 10px rgba(255, 105, 180, 0.7),
                0 0 21px rgba(255, 105, 180, 0.7),
                0 0 42px rgba(0, 255, 255, 0.5), /* Cyan */
                0 0 82px rgba(0, 255, 255, 0.5),
                0 0 92px rgba(0, 255, 255, 0.5),
                0 0 102px rgba(0, 255, 255, 0.5),
                0 0 151px rgba(0, 255, 255, 0.5);
        }
        .text-shadow-neon-sm {
            text-shadow: 0 0 5px #fff, 0 0 10px #ff00ff, 0 0 15px #00ffff;
        }
        @keyframes neon-glow {
            0%, 100% { box-shadow: 0 0 5px #facc15, 0 0 10px #facc15, 0 0 20px #facc15, 0 0 40px #a78bfa, 0 0 80px #a78bfa; }
            50% { box-shadow: 0 0 10px #facc15, 0 0 20px #facc15, 0 0 30px #facc15, 0 0 60px #a78bfa, 0 0 120px #a78bfa; }
        }
        .animate-neon-glow { animation: neon-glow 3s ease-in-out infinite alternate; }
        @keyframes pulse-neon {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        .animate-pulse-neon { animation: pulse-neon 2s ease-in-out infinite alternate; }
        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-bounce-subtle { animation: bounce-subtle 2s ease-in-out infinite; }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 10s linear infinite; }
        @keyframes glow-item {
            0%, 100% { box-shadow: 0 0 5px rgba(255,255,0,0.5), 0 0 10px rgba(255,165,0,0.5); }
            50% { box-shadow: 0 0 10px rgba(255,255,0,0.8), 0 0 20px rgba(255,165,0,0.8); }
        }
        .animate-glow-item { animation: glow-item 2s ease-in-out infinite alternate; }
        .bg-vegas-pattern {
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 30%),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 30%),
                linear-gradient(to bottom right, rgba(255, 0, 0, 0.05), rgba(255, 0, 255, 0.05));
            background-size: 100px 100px;
            animation: sparkle 15s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 to-black p-4 sm:p-8 relative overflow-hidden">
    
    <!-- Subtle background glitter effect -->
    <div class="absolute inset-0 z-0 bg-vegas-pattern opacity-10"></div>

    <header class="text-center mb-10 relative z-10">
        <h1 class="text-5xl sm:text-6xl font-extrabold text-white leading-tight mb-3 font-['Orbitron'] text-shadow-neon">
            <span class="text-yellow-400">LASWEI'GAS</span> MUSIC
        </h1>
        <p class="text-2xl text-pink-300 font-semibold animate-pulse-neon">
            Votre Ticket pour la Playlist Ultime !
        </p>
    </header>

    <main id="app-container" class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-10 relative z-10">
        <!-- Conteneur pour l'indicateur de chargement -->
        <div id="loading-indicator" class="lg:col-span-2 flex flex-col items-center justify-center py-20">
            <i data-lucide="loader-2" class="w-16 h-16 text-yellow-400 animate-spin-slow animate-pulse"></i>
            <p class="mt-6 text-xl text-pink-400 font-bold animate-pulse-neon">Ouverture des portes de LasWei'GAs Music...</p>
        </div>

        <!-- Conteneurs pour les deux sections de l'application -->
        <div id="form-section" class="hidden">
            <div class="bg-gradient-to-br from-purple-800 to-indigo-900 p-6 rounded-3xl shadow-2xl border-4 border-yellow-400 transform transition-transform duration-300 hover:scale-[1.01] animate-neon-glow">
                <h2 class="text-3xl font-extrabold text-yellow-300 mb-6 flex items-center justify-center text-shadow-neon">
                    <i data-lucide="music" class="mr-3 h-8 w-8 text-pink-400 animate-pulse-neon"></i>
                    Proposer un Titre Scintillant
                </h2>
                <form id="submission-form" class="space-y-6">
                    <div>
                        <label for="title" class="block text-lg font-bold text-gray-100 mb-2">Titre de la Chanson</label>
                        <input
                            id="title"
                            type="text"
                            required
                            placeholder="Ex: Viva Las Vegas"
                            class="mt-1 block w-full px-5 py-3 border-2 border-pink-500 rounded-xl shadow-inner bg-gray-900 text-yellow-300 placeholder-gray-500 focus:ring-pink-400 focus:border-pink-400 transition-all duration-200 text-lg"
                        />
                    </div>
                    <div>
                        <label for="artist" class="block text-lg font-bold text-gray-100 mb-2">Artiste √âtoile</label>
                        <input
                            id="artist"
                            type="text"
                            required
                            placeholder="Ex: Elvis Presley"
                            class="mt-1 block w-full px-5 py-3 border-2 border-pink-500 rounded-xl shadow-inner bg-gray-900 text-yellow-300 placeholder-gray-500 focus:ring-pink-400 focus:border-pink-400 transition-all duration-200 text-lg"
                        />
                    </div>
                    <button
                        id="submit-button"
                        type="submit"
                        class="w-full flex justify-center items-center py-3 px-6 border-4 border-yellow-300 rounded-full shadow-lg text-white font-extrabold bg-gradient-to-r from-red-600 to-purple-600 hover:from-red-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-purple-900 disabled:opacity-50 transition-all duration-300 transform hover:scale-[1.02] text-xl animate-bounce-subtle"
                    >
                        <i data-lucide="zap" class="mr-3 h-6 w-6"></i>
                        Envoyer au DJ !
                    </button>
                </form>
                <div id="submission-message" class="mt-6 hidden p-4 rounded-xl text-md font-semibold text-center"></div>
                <p class="mt-6 text-xs text-gray-400 text-center">
                    Votre Pass Unique pour la Soir√©e : <span id="user-id-display" class="font-mono text-yellow-200 break-all">Chargement...</span>
                </p>
            </div>
        </div>

        <div id="queue-section" class="hidden">
            <div class="bg-gradient-to-br from-gray-900 to-black p-6 rounded-3xl shadow-2xl border-4 border-red-500">
                <h2 class="text-3xl font-extrabold text-yellow-300 mb-6 flex items-center justify-center border-b-4 border-red-500 pb-4 text-shadow-neon">
                    <!-- Le titre change selon le mode (DJ ou Visiteur) -->
                    <i data-lucide="check-circle" class="mr-3 h-8 w-8 text-green-400 animate-pulse-neon"></i>
                    <span id="queue-title">La File d'Attente</span> (<span id="queue-count">0</span>)
                </h2>
                <ul id="song-list" class="space-y-4">
                    <!-- Les chansons seront inject√©es ici par JS -->
                </ul>
                <div id="empty-queue-message" class="text-center py-10 text-yellow-200 animate-pulse hidden">
                    <p class="text-2xl font-bold">La piste de danse attend ! üíÉüï∫</p>
                    <p class="text-lg mt-2 text-gray-300">Soyez le premier √† lancer la fiesta.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-16 text-center text-md text-gray-400 relative z-10">
        <p>Cr√©√© pour briller √† LasWei'GAs | App ID: <span id="app-id-display" class="text-yellow-300"></span></p>
    </footer>

    <!-- Firebase SDKs import (must be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Ajout de la gestion de l'√©tat persistant pour l'ID utilisateur
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, doc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration Firebase (MISES √Ä JOUR AVEC VOS VALEURS) ---
        // ID du DJ √† utiliser pour le mode Console du DJ
        const DJ_ID = 'd7f082b7-11ae-400b-b1ea-e1a02a130932'; 
        // Laissez l'API Key vide, elle est inject√©e par l'environnement
        const DJ_TOKEN = DJ_ID; // Utiliser l'ID du DJ comme jeton pour le custom auth
        
        // VOS VALEURS DE CONFIGURATION: (G√©n√©ralement inject√©es par l'environnement)
        const APP_ID = 'lasweigas'; // Nom de l'app par d√©faut
        const FIREBASE_CONFIG = {
            apiKey: "",
            authDomain: "lasweigas.firebaseapp.com",
            projectId: "lasweigas",
            storageBucket: "lasweigas.firebasestorage.app",
            messagingSenderId: "620039526308",
            appId: "1:620039526308:web:83a6e370fb0379111c9331",
            measurementId: "G-KPF8D1ZNDX"
        };
        // -------------------------------------------------------------------

        // Configuration pour l'environnement de d√©veloppement/d√©ploiement
        const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_CONFIG;
        // Le jeton initial sera l'ID du DJ si l'utilisateur y a acc√®s, sinon il sera null/vide.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : DJ_TOKEN; 

        // R√©f√©rences aux √©l√©ments du DOM
        const loadingIndicator = document.getElementById('loading-indicator');
        const formSection = document.getElementById('form-section');
        const queueSection = document.getElementById('queue-section');
        const songList = document.getElementById('song-list');
        const emptyQueueMessage = document.getElementById('empty-queue-message');
        const submissionForm = document.getElementById('submission-form');
        const titleInput = document.getElementById('title');
        const artistInput = document.getElementById('artist');
        const submitButton = document.getElementById('submit-button');
        const submissionMessageDiv = document.getElementById('submission-message');
        const queueCountSpan = document.getElementById('queue-count');
        const userIdDisplay = document.getElementById('user-id-display');
        const queueTitle = document.getElementById('queue-title');

        document.getElementById('app-id-display').textContent = appId;


        // Variables globales pour Firebase
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let isDjMode = false; // Nouveau mode pour le DJ

        // Cl√© localStorage pour l'ID utilisateur persistant (NON UTILIS√âE - on utilise l'UID d'Auth)
        // L'UID d'authentification Firebase sera utilis√© comme userId r√©el pour les r√®gles Firestore.

        // Fonction d'aide pour g√©n√©rer un ID al√©atoire si on doit utiliser un ID non-Auth (visiteur)
        const getNonAuthUserId = () => {
            return crypto.randomUUID();
        };

        // --- Initialisation et Authentification ---

        async function initializeAppAndAuth() {
            try {
                // Initialiser l'application Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // D√©terminer le mode de connexion
                if (initialAuthToken) {
                    // Si un jeton est fourni (ici, l'ID du DJ), on tente la connexion personnalis√©e
                    await signInWithCustomToken(auth, initialAuthToken);
                    // L'UID de l'utilisateur AUTH sera l'ID du DJ si la connexion r√©ussit
                    if (auth.currentUser && auth.currentUser.uid === DJ_ID) {
                        isDjMode = true;
                    }
                } else {
                    // Sinon, on utilise l'authentification anonyme pour tous les visiteurs
                    await signInAnonymously(auth);
                    isDjMode = false;
                }

                // Listener d'√©tat d'authentification
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Si le user.uid correspond √† l'ID DJ, on est en mode DJ
                        if (user.uid === DJ_ID) {
                            isDjMode = true;
                            currentUserId = "DJ-CONSOLE"; 
                            queueTitle.textContent = "Console du DJ";
                        } else {
                            // Pour les visiteurs, on utilise l'UID de l'auth anonyme
                            isDjMode = false;
                            currentUserId = user.uid;
                            queueTitle.textContent = "La File d'Attente";
                        }
                    } else {
                        // En cas de d√©connexion inattendue
                        currentUserId = getNonAuthUserId();
                        isDjMode = false;
                    }
                    // Afficher l'ID du Visiteur (Tronqu√©) ou "DJ-CONSOLE"
                    userIdDisplay.textContent = isDjMode ? currentUserId : currentUserId.substring(0, 8) + '...';
                    isAuthReady = true;
                    hideLoadingAndShowApp();
                    setupRealtimeListener(); // Lance l'√©coute apr√®s l'authentification
                });

            } catch (e) {
                console.error("Erreur d'initialisation Firebase:", e);
                displayError("Erreur critique: √âchec de l'initialisation Firebase ou de la connexion. V√©rifiez la console.");
            }
        }

        // --- Fonctions d'interface utilisateur ---

        function hideLoadingAndShowApp() {
            loadingIndicator.classList.add('hidden');
            formSection.classList.remove('hidden');
            queueSection.classList.remove('hidden');
        }

        function displayError(message) {
            loadingIndicator.innerHTML = `
                <div class="p-8 text-center bg-red-900 border-4 border-red-500 text-white rounded-xl m-4 shadow-neon-red">
                    <h1 class="text-3xl font-extrabold text-yellow-300">Erreur de l'Application</h1>
                    <p class="mt-4 text-lg">${message}</p>
                    <p class="mt-2 text-sm text-gray-300">Veuillez rafra√Æchir la page.</p>
                </div>
            `;
            loadingIndicator.classList.remove('hidden');
            formSection.classList.add('hidden');
            queueSection.classList.add('hidden');
        }

        function displaySubmissionMessage(text, type) {
            submissionMessageDiv.textContent = text;
            submissionMessageDiv.classList.remove('hidden', 'bg-green-600', 'bg-red-700', 'border-green-400', 'border-red-400');
            
            if (type === 'success') {
                submissionMessageDiv.classList.add('bg-green-600', 'text-white', 'shadow-lg', 'border-2', 'border-green-400', 'animate-fade-in');
            } else {
                submissionMessageDiv.classList.add('bg-red-700', 'text-white', 'shadow-lg', 'border-2', 'border-red-400', 'animate-fade-in');
            }

            setTimeout(() => {
                submissionMessageDiv.classList.add('hidden');
            }, 5000);
        }

        // --- Logique Firestore ---

        function setupRealtimeListener() {
            if (!db || !isAuthReady) {
                console.warn("Firestore non pr√™t ou authentification non termin√©e. Report du listener.");
                return;
            }

            // Chemin public pour la collaboration : /artifacts/{appId}/public/data/song_requests
            const requestsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'song_requests');
            
            // Requ√™te: toutes les chansons qui n'ont pas encore √©t√© jou√©es
            const q = query(
                requestsCollection,
                where('played', '==', false)
            );

            onSnapshot(q, (snapshot) => {
                let songListArray = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convertir le timestamp en objet Date pour le tri c√¥t√© client
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date(),
                }));

                // Tri c√¥t√© client par timestamp (le plus ancien en premier)
                songListArray.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());

                renderSongList(songListArray);
            }, (err) => {
                console.error("Firestore Snapshot Error:", err);
                displayError("Erreur de r√©cup√©ration de la file d'attente. Probl√®me de connexion ou de permission.");
            });
        }

        // --- Rendu de la File d'Attente ---

        function renderSongList(songs) {
            songList.innerHTML = ''; // Nettoyer la liste
            queueCountSpan.textContent = songs.length;
            
            // Mise √† jour du titre
            if(isDjMode) {
                queueTitle.textContent = "Console du DJ";
            } else {
                queueTitle.textContent = "La File d'Attente";
            }


            if (songs.length === 0) {
                emptyQueueMessage.classList.remove('hidden');
            } else {
                emptyQueueMessage.classList.add('hidden');
            }

            songs.forEach((song, index) => {
                const li = document.createElement('li');
                
                // Styles d'article en fonction de la position dans la file (le premier brille)
                const articleClass = index === 0 ? 
                    'bg-gradient-to-r from-yellow-700 to-orange-600 border-l-8 border-yellow-300 animate-glow-item' : 
                    'bg-gradient-to-r from-gray-800 to-gray-700 border-l-8 border-purple-600';
                const titleClass = index === 0 ? 'text-white text-shadow-neon-sm' : 'text-yellow-300';
                
                // Affichage de l'ID du Soumetteur (simplifi√©)
                const submitterId = song.user_id ? song.user_id.substring(0, 8) : 'Anonyme';

                // G√©n√©ration des boutons d'action (DJ) - Affich√©s SEULEMENT en mode DJ
                const buttonsHtml = isDjMode ? `
                    <div class="flex space-x-3 ml-4">
                        <button
                            onclick="handleMarkPlayed('${song.id}')"
                            class="p-3 bg-green-600 text-white rounded-full shadow-lg hover:bg-green-700 transition-all transform hover:scale-110 active:scale-95 group relative border-2 border-green-400"
                            aria-label="Marquer comme jou√©e"
                        >
                            <i data-lucide="check-circle" class="h-6 w-6"></i>
                            <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 p-2 text-xs bg-black text-white rounded-md opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200 whitespace-nowrap">Jou√©e</span>
                        </button>
                        <button
                            onclick="handleDelete('${song.id}')"
                            class="p-3 bg-red-600 text-white rounded-full shadow-lg hover:bg-red-700 transition-all transform hover:scale-110 active:scale-95 group relative border-2 border-red-400"
                            aria-label="Supprimer de la liste"
                        >
                            <i data-lucide="trash-2" class="h-6 w-6"></i>
                            <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 p-2 text-xs bg-black text-white rounded-md opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200 whitespace-nowrap">Supprimer</span>
                        </button>
                    </div>
                ` : '';

                li.className = `p-4 rounded-xl flex justify-between items-center shadow-lg transition-all transform hover:scale-[1.02] duration-200 ${articleClass}`;
                li.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-xl font-bold truncate ${titleClass}">
                            ${index + 1}. ${song.title}
                        </p>
                        <p class="text-md text-gray-200 truncate mt-1">
                            par <span class="font-semibold text-pink-300">${song.artist}</span>
                        </p>
                        <p class="text-xs text-gray-400 mt-2">
                            Soumis par: <span class="font-mono text-xs text-purple-300">${submitterId}</span> √†: ${song.timestamp.toLocaleTimeString('fr-FR')}
                        </p>
                    </div>
                    ${buttonsHtml}
                `;
                songList.appendChild(li);
            });
            // R√©initialiser les ic√¥nes Lucide apr√®s l'ajout des √©l√©ments
            LucideIcons.createIcons(); 
        }

        // --- Gestion des √âv√©nements ---

        submissionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db || !isAuthReady) {
                displaySubmissionMessage("Erreur: L'application n'est pas compl√®tement charg√©e. Veuillez r√©essayer.", 'error');
                return;
            }

            const title = titleInput.value.trim();
            const artist = artistInput.value.trim();

            if (!title || !artist) return;

            submitButton.disabled = true;
            submitButton.innerHTML = '<i data-lucide="loader-2" class="animate-spin mr-3 h-6 w-6"></i> Envoi...';
            LucideIcons.createIcons();

            const newRequest = {
                title: title,
                artist: artist,
                // On utilise l'UID d'Auth pour la soumission.
                user_id: auth.currentUser ? auth.currentUser.uid : getNonAuthUserId(), 
                timestamp: new Date(),
                played: false,
                upvotes: 0,
            };

            try {
                const requestsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'song_requests');
                await addDoc(requestsCollection, newRequest);
                
                titleInput.value = '';
                artistInput.value = '';
                displaySubmissionMessage('Suggestion envoy√©e ! Merci pour votre contribution.', 'success');

            } catch (e) {
                console.error("Submission Error:", e);
                displaySubmissionMessage("Erreur lors de l'envoi. Probl√®me de permission ou de connexion.", 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i data-lucide="zap" class="mr-3 h-6 w-6"></i> Envoyer au DJ !';
                LucideIcons.createIcons();
            }
        });

        window.handleMarkPlayed = async (songId) => {
            // V√©rifie le mode DJ et l'UID r√©el de l'utilisateur connect√©
            if (!db || !isDjMode || (auth.currentUser.uid !== DJ_ID)) return; 
            try {
                const songRef = doc(db, 'artifacts', appId, 'public', 'data', 'song_requests', songId);
                await updateDoc(songRef, {
                    played: true,
                    played_at: new Date(),
                });
            } catch (e) {
                console.error("Mark Played Error:", e);
                displayError("Impossible de marquer la chanson comme jou√©e. V√©rifiez vos permissions.");
            }
        };

        window.handleDelete = async (songId) => {
            // V√©rifie le mode DJ et l'UID r√©el de l'utilisateur connect√©
            if (!db || !isDjMode || (auth.currentUser.uid !== DJ_ID)) return; 
            try {
                const songRef = doc(db, 'artifacts', appId, 'public', 'data', 'song_requests', songId);
                await deleteDoc(songRef);
            } catch (e) {
                console.error("Delete Error:", e);
                displayError("Impossible de supprimer la chanson. V√©rifiez vos permissions.");
            }
        };

        // Enregistrez la fonction createIcons dans un objet global pour l'utiliser dans renderSongList
        const LucideIcons = { 
            createIcons: () => {
                if (window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons();
                }
            }
        };

        // Lancement de l'initialisation de l'application au chargement de la fen√™tre
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>
